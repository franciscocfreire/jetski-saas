{
	"info": {
		"_postman_id": "sprint3-jornadas-com-testes",
		"name": "Jetski Sprint 3 - Jornadas Completas com Testes",
		"description": "Collection completa com jornadas de Combust√≠vel (RN03), Comiss√µes (RN04) e Fechamento (RN06) com testes automatizados.\n\n**M√≥dulos Cobertos:**\n- ‚õΩ Combust√≠vel (RN03): pol√≠ticas, abastecimento\n- üí∞ Comiss√µes (RN04): c√°lculo hier√°rquico, aprova√ß√£o, pagamento\n- üìä Fechamento (RN06): di√°rio e mensal com bloqueio\n\n**Features:**\n- ‚úÖ Testes automatizados em cada requisi√ß√£o\n- ‚úÖ Vari√°veis din√¢micas (IDs salvos automaticamente)\n- ‚úÖ Valida√ß√£o de status codes, estrutura JSON, valores\n- ‚úÖ Scripts de pr√©-requisi√ß√£o para setup\n- ‚úÖ Cleanup autom√°tico entre jornadas\n\n**Como Usar:**\n1. Importe o environment `Local.postman_environment.json`\n2. Execute a pasta \"0Ô∏è‚É£ Setup\" para autenticar\n3. Execute as jornadas sequencialmente ou use Collection Runner\n4. Veja os resultados dos testes na aba \"Test Results\"\n\n**Vers√£o:** 0.8.0 (Sprint 3)\n**Total de Testes:** ~80 assertions automatizados",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "0Ô∏è‚É£ Setup - Autentica√ß√£o",
			"item": [
				{
					"name": "Auth - Get Gerente Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Resposta cont√©m access_token', function() {",
									"    const json = pm.response.json();",
									"    pm.expect(json).to.have.property('access_token');",
									"    pm.expect(json.access_token).to.be.a('string').and.not.empty;",
									"});",
									"",
									"pm.test('Token possui tipo Bearer', function() {",
									"    const json = pm.response.json();",
									"    pm.expect(json.token_type).to.eql('Bearer');",
									"});",
									"",
									"// Salvar token para uso nas pr√≥ximas requisi√ß√µes",
									"const json = pm.response.json();",
									"pm.environment.set('gerente_token', json.access_token);",
									"pm.environment.set('token_expires_in', json.expires_in);",
									"",
									"console.log('‚úÖ Token do GERENTE salvo com sucesso');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/x-www-form-urlencoded"
							}
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{
									"key": "grant_type",
									"value": "password",
									"type": "text"
								},
								{
									"key": "client_id",
									"value": "jetski-api",
									"type": "text"
								},
								{
									"key": "client_secret",
									"value": "jetski-secret",
									"type": "text"
								},
								{
									"key": "username",
									"value": "gerente@acme.com",
									"type": "text"
								},
								{
									"key": "password",
									"value": "gerente123",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/jetski-saas/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "jetski-saas", "protocol", "openid-connect", "token"]
						},
						"description": "Autentica persona GERENTE via Keycloak OAuth2 Password Flow.\n\n**Persona:** üë®‚Äçüíº GERENTE\n**Roles:** GERENTE, ADMIN_TENANT\n**Permiss√µes:** Aprovar fechamentos, comiss√µes, gerenciar pol√≠ticas"
					},
					"response": []
				},
				{
					"name": "Auth - Get Operador Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"pm.environment.set('operador_token', json.access_token);",
									"console.log('‚úÖ Token do OPERADOR salvo');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{
									"key": "grant_type",
									"value": "password"
								},
								{
									"key": "client_id",
									"value": "jetski-api"
								},
								{
									"key": "client_secret",
									"value": "jetski-secret"
								},
								{
									"key": "username",
									"value": "operador@acme.com"
								},
								{
									"key": "password",
									"value": "operador123"
								}
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/jetski-saas/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "jetski-saas", "protocol", "openid-connect", "token"]
						}
					},
					"response": []
				},
				{
					"name": "Auth - Get Financeiro Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"pm.environment.set('financeiro_token', json.access_token);",
									"console.log('‚úÖ Token do FINANCEIRO salvo');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{
									"key": "grant_type",
									"value": "password"
								},
								{
									"key": "client_id",
									"value": "jetski-api"
								},
								{
									"key": "client_secret",
									"value": "jetski-secret"
								},
								{
									"key": "username",
									"value": "gerente@acme.com"
								},
								{
									"key": "password",
									"value": "gerente123"
								}
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/jetski-saas/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "jetski-saas", "protocol", "openid-connect", "token"]
						}
					},
					"response": []
				}
			],
			"description": "Autentica todas as personas necess√°rias via Keycloak.\n\n**Tokens Obtidos:**\n- GERENTE: aprova√ß√µes, pol√≠ticas\n- OPERADOR: opera√ß√µes di√°rias\n- FINANCEIRO: pagamentos"
		},
		{
			"name": "1Ô∏è‚É£ Jornada: Fechamento Di√°rio Completo",
			"item": [
				{
					"name": "1.1 Consolidar Fechamento Di√°rio",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 201 Created', function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test('Resposta √© JSON v√°lido', function() {",
									"    pm.response.to.be.json;",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Possui ID do fechamento', function() {",
									"    pm.expect(json).to.have.property('id');",
									"    pm.expect(json.id).to.be.a('string').and.not.empty;",
									"});",
									"",
									"pm.test('Status inicial √© \"aberto\"', function() {",
									"    pm.expect(json.status).to.eql('aberto');",
									"});",
									"",
									"pm.test('N√£o est√° bloqueado inicialmente', function() {",
									"    pm.expect(json.bloqueado).to.be.false;",
									"});",
									"",
									"pm.test('Data de refer√™ncia corresponde ao enviado', function() {",
									"    const dtReferencia = pm.variables.get('dt_referencia');",
									"    pm.expect(json.dtReferencia).to.eql(dtReferencia);",
									"});",
									"",
									"pm.test('Totais financeiros s√£o n√∫meros v√°lidos', function() {",
									"    pm.expect(json.totalLocacoes).to.be.a('number').and.at.least(0);",
									"    pm.expect(json.totalFaturado).to.be.a('number').and.at.least(0);",
									"    pm.expect(json.totalCombustivel).to.be.a('number').and.at.least(0);",
									"    pm.expect(json.totalComissoes).to.be.a('number').and.at.least(0);",
									"});",
									"",
									"pm.test('Possui breakdown por forma de pagamento', function() {",
									"    pm.expect(json).to.have.property('totalDinheiro');",
									"    pm.expect(json).to.have.property('totalCartao');",
									"    pm.expect(json).to.have.property('totalPix');",
									"});",
									"",
									"pm.test('Total faturado = soma das formas de pagamento', function() {",
									"    const soma = json.totalDinheiro + json.totalCartao + json.totalPix;",
									"    pm.expect(json.totalFaturado).to.be.closeTo(soma, 0.01);",
									"});",
									"",
									"// Salvar ID para pr√≥ximas requisi√ß√µes",
									"pm.environment.set('fechamento_diario_id', json.id);",
									"console.log('‚úÖ Fechamento di√°rio consolidado:', json.id);"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Definir data de refer√™ncia (hoje)",
									"const hoje = new Date().toISOString().split('T')[0];",
									"pm.variables.set('dt_referencia', hoje);",
									"console.log('üìÖ Data de refer√™ncia:', hoje);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{operador_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"dtReferencia\": \"{{dt_referencia}}\",\n  \"observacoes\": \"Consolida√ß√£o autom√°tica via Postman\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/dia/consolidar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "dia", "consolidar"]
						},
						"description": "**Persona:** üëî OPERADOR\n\n**Business Logic:**\n- Agrega todas as loca√ß√µes finalizadas do dia\n- Calcula totais por forma de pagamento\n- Consolida abastecimentos e comiss√µes\n- Cria fechamento com status ABERTO\n\n**Testes:** 10 assertions"
					},
					"response": []
				},
				{
					"name": "1.2 Consultar Fechamento Criado",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('ID corresponde ao criado', function() {",
									"    const id = pm.environment.get('fechamento_diario_id');",
									"    pm.expect(json.id).to.eql(id);",
									"});",
									"",
									"pm.test('Possui operador respons√°vel', function() {",
									"    pm.expect(json).to.have.property('operadorId');",
									"    pm.expect(json.operadorId).to.be.a('string').and.not.empty;",
									"});",
									"",
									"pm.test('Timestamps de auditoria presentes', function() {",
									"    pm.expect(json).to.have.property('createdAt');",
									"    pm.expect(json).to.have.property('updatedAt');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{operador_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/dia/{{fechamento_diario_id}}",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "dia", "{{fechamento_diario_id}}"]
						}
					},
					"response": []
				},
				{
					"name": "1.3 Fechar o Dia (Lock)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Status mudou para \"fechado\"', function() {",
									"    pm.expect(json.status).to.eql('fechado');",
									"});",
									"",
									"pm.test('Agora est√° bloqueado (RN06)', function() {",
									"    pm.expect(json.bloqueado).to.be.true;",
									"});",
									"",
									"pm.test('Possui data de fechamento', function() {",
									"    pm.expect(json).to.have.property('dtFechamento');",
									"    pm.expect(json.dtFechamento).to.not.be.null;",
									"});",
									"",
									"console.log('üîí Fechamento bloqueado - edi√ß√µes retroativas impedidas');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{operador_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/dia/{{fechamento_diario_id}}/fechar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "dia", "{{fechamento_diario_id}}", "fechar"]
						},
						"description": "**RN06:** Bloqueio retroativo\n\n**Efeitos:**\n- Status: aberto ‚Üí fechado\n- bloqueado = true\n- dtFechamento = now()\n- Loca√ß√µes do dia n√£o podem mais ser editadas\n\n**Testes:** 4 assertions"
					},
					"response": []
				},
				{
					"name": "1.4 Tentar Reabrir (Gerente)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Status voltou para \"aberto\"', function() {",
									"    pm.expect(json.status).to.eql('aberto');",
									"});",
									"",
									"pm.test('Bloqueio foi removido', function() {",
									"    pm.expect(json.bloqueado).to.be.false;",
									"});",
									"",
									"pm.test('Data de fechamento foi limpa', function() {",
									"    pm.expect(json.dtFechamento).to.be.null;",
									"});",
									"",
									"console.log('üîì Fechamento reaberto pelo GERENTE');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/dia/{{fechamento_diario_id}}/reabrir",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "dia", "{{fechamento_diario_id}}", "reabrir"]
						},
						"description": "**Persona:** üë®‚Äçüíº GERENTE\n\n**Regra:** S√≥ pode reabrir se status == \"fechado\"\n**Erro:** 400 se status == \"aprovado\" (imut√°vel)\n\n**Testes:** 3 assertions"
					},
					"response": []
				},
				{
					"name": "1.5 Fechar Novamente",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"pm.expect(json.status).to.eql('fechado');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{operador_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/dia/{{fechamento_diario_id}}/fechar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "dia", "{{fechamento_diario_id}}", "fechar"]
						}
					},
					"response": []
				},
				{
					"name": "1.6 Aprovar Fechamento (Gerente)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Status final √© \"aprovado\"', function() {",
									"    pm.expect(json.status).to.eql('aprovado');",
									"});",
									"",
									"pm.test('Permanece bloqueado (imut√°vel RN06)', function() {",
									"    pm.expect(json.bloqueado).to.be.true;",
									"});",
									"",
									"console.log('‚úÖ Fechamento APROVADO - permanentemente bloqueado');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/dia/{{fechamento_diario_id}}/aprovar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "dia", "{{fechamento_diario_id}}", "aprovar"]
						},
						"description": "**RN06:** Estado final imut√°vel\n\n**ABAC:** Requer role GERENTE\n\n**Efeitos:**\n- Status: fechado ‚Üí aprovado\n- N√£o pode mais ser reaberto\n- Dados financeiros consolidados\n\n**Testes:** 2 assertions"
					},
					"response": []
				},
				{
					"name": "1.7 Tentar Reabrir Aprovado (Deve Falhar)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 400 Bad Request', function() {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Mensagem de erro apropriada', function() {",
									"    pm.expect(json.message).to.include('aprovado');",
									"    pm.expect(json.message).to.include('n√£o pode ser reaberto');",
									"});",
									"",
									"pm.test('Tipo de erro √© BusinessException', function() {",
									"    pm.expect(json.error).to.include('Business');",
									"});",
									"",
									"console.log('‚úÖ Valida√ß√£o RN06: fechamento aprovado √© imut√°vel');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/dia/{{fechamento_diario_id}}/reabrir",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "dia", "{{fechamento_diario_id}}", "reabrir"]
						},
						"description": "**Teste Negativo**\n\nValida que fechamento aprovado n√£o pode ser reaberto (RN06)\n\n**Expected:** 400 Bad Request\n**Testes:** 3 assertions"
					},
					"response": []
				}
			],
			"description": "**Jornada Completa:** Consolida√ß√£o ‚Üí Fechamento ‚Üí Reabertura ‚Üí Aprova√ß√£o\n\n**Personas:** OPERADOR, GERENTE\n**Total de Testes:** 27 assertions\n\n**Fluxo de Estados (RN06):**\n```\nABERTO ‚Üí FECHADO ‚Üí APROVADO ‚õî\n  ‚Üë         ‚Üì\n  ‚îî‚îÄreabrir‚îÄ‚îò\n```"
		},
		{
			"name": "2Ô∏è‚É£ Jornada: Comiss√µes - Do C√°lculo ao Pagamento",
			"item": [
				{
					"name": "2.1 Criar Pol√≠tica de Comiss√£o (Modelo)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 201 Created', function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Possui ID da pol√≠tica', function() {",
									"    pm.expect(json).to.have.property('id');",
									"});",
									"",
									"pm.test('N√≠vel √© MODELO (hierarquia RN04)', function() {",
									"    pm.expect(json.nivel).to.eql('MODELO');",
									"});",
									"",
									"pm.test('Tipo √© PERCENTUAL', function() {",
									"    pm.expect(json.tipoComissao).to.eql('PERCENTUAL');",
									"});",
									"",
									"pm.test('Percentual configurado corretamente', function() {",
									"    pm.expect(json.percentual).to.eql(12.0);",
									"});",
									"",
									"pm.test('Pol√≠tica est√° ativa', function() {",
									"    pm.expect(json.ativo).to.be.true;",
									"});",
									"",
									"pm.environment.set('politica_comissao_id', json.id);",
									"console.log('‚úÖ Pol√≠tica de comiss√£o criada (MODELO, 12%)');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"nivel\": \"MODELO\",\n  \"modeloId\": \"{{modelo_id}}\",\n  \"tipoComissao\": \"PERCENTUAL\",\n  \"percentual\": 12.0,\n  \"descricao\": \"Pol√≠tica teste via Postman - 12% por modelo\",\n  \"ativo\": true\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/v1/politicas-comissao",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "politicas-comissao"]
						},
						"description": "**Persona:** üë®‚Äçüíº GERENTE\n\n**RN04:** Hierarquia de pol√≠ticas\n1. CAMPANHA (prioridade 1)\n2. **MODELO** (prioridade 2) ‚¨Ö AQUI\n3. FAIXA_DURACAO (prioridade 3)\n4. VENDEDOR (prioridade 4)\n\n**Testes:** 6 assertions"
					},
					"response": []
				},
				{
					"name": "2.2 Listar Pol√≠ticas Ativas",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Resposta √© array', function() {",
									"    pm.expect(json).to.be.an('array');",
									"});",
									"",
									"pm.test('Cont√©m a pol√≠tica rec√©m-criada', function() {",
									"    const politicaId = pm.environment.get('politica_comissao_id');",
									"    const found = json.find(p => p.id === politicaId);",
									"    pm.expect(found).to.not.be.undefined;",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/politicas-comissao?ativo=true",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "politicas-comissao"],
							"query": [
								{
									"key": "ativo",
									"value": "true"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "2.3 Consultar Comiss√µes Pendentes",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Resposta √© array de comiss√µes', function() {",
									"    pm.expect(json).to.be.an('array');",
									"});",
									"",
									"if (json.length > 0) {",
									"    const comissao = json[0];",
									"    ",
									"    pm.test('Comiss√£o possui estrutura correta', function() {",
									"        pm.expect(comissao).to.have.property('id');",
									"        pm.expect(comissao).to.have.property('vendedorId');",
									"        pm.expect(comissao).to.have.property('locacaoId');",
									"        pm.expect(comissao).to.have.property('valorBase');",
									"        pm.expect(comissao).to.have.property('valorComissao');",
									"        pm.expect(comissao).to.have.property('taxaAplicada');",
									"        pm.expect(comissao).to.have.property('status');",
									"    });",
									"    ",
									"    pm.test('Status √© PENDENTE', function() {",
									"        pm.expect(comissao.status).to.eql('PENDENTE');",
									"    });",
									"    ",
									"    pm.test('C√°lculo da comiss√£o (RN04)', function() {",
									"        const esperado = comissao.valorBase * (comissao.taxaAplicada / 100);",
									"        pm.expect(comissao.valorComissao).to.be.closeTo(esperado, 0.01);",
									"    });",
									"    ",
									"    // Salvar para aprova√ß√£o",
									"    pm.environment.set('comissao_id', comissao.id);",
									"    console.log('‚úÖ Comiss√£o pendente encontrada:', comissao.valorComissao);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/comissoes/pendentes",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "comissoes", "pendentes"]
						},
						"description": "**Persona:** üë®‚Äçüíº GERENTE\n\n**RN04:** Lista comiss√µes aguardando aprova√ß√£o\n\n**Valida√ß√µes:**\n- Estrutura da comiss√£o\n- C√°lculo correto (valorBase √ó taxa)\n- Status PENDENTE\n\n**Testes:** 7 assertions (se houver comiss√µes)"
					},
					"response": []
				},
				{
					"name": "2.4 Aprovar Comiss√£o (Gerente)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const comissaoId = pm.environment.get('comissao_id');",
									"",
									"if (!comissaoId) {",
									"    console.log('‚ö†Ô∏è Sem comiss√µes para aprovar - pulando teste');",
									"    pm.test.skip('Sem comiss√µes dispon√≠veis');",
									"    return;",
									"}",
									"",
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Status mudou para APROVADA', function() {",
									"    pm.expect(json.status).to.eql('APROVADA');",
									"});",
									"",
									"pm.test('Valores permanecem inalterados', function() {",
									"    pm.expect(json).to.have.property('valorComissao');",
									"    pm.expect(json.valorComissao).to.be.a('number').and.above(0);",
									"});",
									"",
									"console.log('‚úÖ Comiss√£o APROVADA pelo GERENTE');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"observacoes\": \"Aprovado via Postman - performance OK\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/v1/comissoes/{{comissao_id}}/aprovar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "comissoes", "{{comissao_id}}", "aprovar"]
						},
						"description": "**Persona:** üë®‚Äçüíº GERENTE\n\n**ABAC:** Valida al√ßada do gerente via OPA\n\n**Workflow:**\nPENDENTE ‚Üí **APROVADA** ‚Üí PAGA\n\n**Testes:** 3 assertions"
					},
					"response": []
				},
				{
					"name": "2.5 Consultar Comiss√µes Aguardando Pagamento",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Resposta √© array', function() {",
									"    pm.expect(json).to.be.an('array');",
									"});",
									"",
									"if (json.length > 0) {",
									"    pm.test('Todas t√™m status APROVADA', function() {",
									"        json.forEach(c => {",
									"            pm.expect(c.status).to.eql('APROVADA');",
									"        });",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{financeiro_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/comissoes/aguardando-pagamento",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "comissoes", "aguardando-pagamento"]
						},
						"description": "**Persona:** üí∞ FINANCEIRO\n\nLista comiss√µes aprovadas que ainda n√£o foram pagas."
					},
					"response": []
				},
				{
					"name": "2.6 Pagar Comiss√£o (Financeiro)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const comissaoId = pm.environment.get('comissao_id');",
									"",
									"if (!comissaoId) {",
									"    console.log('‚ö†Ô∏è Sem comiss√µes para pagar - pulando teste');",
									"    pm.test.skip('Sem comiss√µes dispon√≠veis');",
									"    return;",
									"}",
									"",
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Status final √© PAGA', function() {",
									"    pm.expect(json.status).to.eql('PAGA');",
									"});",
									"",
									"pm.test('Possui data de pagamento', function() {",
									"    pm.expect(json).to.have.property('dataPagamento');",
									"    pm.expect(json.dataPagamento).to.not.be.null;",
									"});",
									"",
									"pm.test('M√©todo de pagamento registrado', function() {",
									"    pm.expect(json).to.have.property('metodoPagamento');",
									"    pm.expect(json.metodoPagamento).to.eql('PIX');",
									"});",
									"",
									"console.log('‚úÖ Comiss√£o PAGA pelo FINANCEIRO');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{financeiro_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"dataPagamento\": \"{{$isoTimestamp}}\",\n  \"metodoPagamento\": \"PIX\",\n  \"comprovante\": \"https://storage.example.com/comprovante-pix.pdf\",\n  \"observacoes\": \"Pagamento efetuado via Postman\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/v1/comissoes/{{comissao_id}}/pagar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "comissoes", "{{comissao_id}}", "pagar"]
						},
						"description": "**Persona:** üí∞ FINANCEIRO\n\n**Workflow Completo:**\nPENDENTE ‚Üí APROVADA ‚Üí **PAGA** ‚úÖ\n\n**ABAC:** Requer role FINANCEIRO\n\n**Testes:** 4 assertions"
					},
					"response": []
				}
			],
			"description": "**Jornada Completa:** Pol√≠tica ‚Üí C√°lculo ‚Üí Aprova√ß√£o ‚Üí Pagamento\n\n**Personas:** GERENTE, FINANCEIRO\n**Total de Testes:** ~20 assertions\n\n**RN04:** Comiss√µes hier√°rquicas com workflow de aprova√ß√£o"
		},
		{
			"name": "3Ô∏è‚É£ Jornada: Fechamento Mensal",
			"item": [
				{
					"name": "3.1 Consolidar M√™s",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 201 Created', function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Possui ID do fechamento mensal', function() {",
									"    pm.expect(json).to.have.property('id');",
									"});",
									"",
									"pm.test('M√™s e ano corretos', function() {",
									"    const mes = pm.variables.get('mes_referencia');",
									"    const ano = pm.variables.get('ano_referencia');",
									"    pm.expect(json.mes).to.eql(parseInt(mes));",
									"    pm.expect(json.ano).to.eql(parseInt(ano));",
									"});",
									"",
									"pm.test('Status inicial √© \"aberto\"', function() {",
									"    pm.expect(json.status).to.eql('aberto');",
									"});",
									"",
									"pm.test('Possui totais consolidados', function() {",
									"    pm.expect(json).to.have.property('totalReceita');",
									"    pm.expect(json).to.have.property('totalDespesas');",
									"    pm.expect(json).to.have.property('diasOperacao');",
									"});",
									"",
									"pm.test('Possui breakdown de comiss√µes', function() {",
									"    pm.expect(json).to.have.property('totalComissoesPendentes');",
									"    pm.expect(json).to.have.property('totalComissoesAprovadas');",
									"    pm.expect(json).to.have.property('totalComissoesPagas');",
									"});",
									"",
									"pm.environment.set('fechamento_mensal_id', json.id);",
									"console.log('‚úÖ Fechamento mensal consolidado:', json.id);"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Definir m√™s/ano (m√™s atual)",
									"const hoje = new Date();",
									"const mes = (hoje.getMonth() + 1).toString();",
									"const ano = hoje.getFullYear().toString();",
									"pm.variables.set('mes_referencia', mes);",
									"pm.variables.set('ano_referencia', ano);",
									"console.log(`üìÖ Consolidando: ${mes}/${ano}`);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"mes\": {{mes_referencia}},\n  \"ano\": {{ano_referencia}},\n  \"observacoes\": \"Fechamento mensal via Postman\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/mes/consolidar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "mes", "consolidar"]
						},
						"description": "**Persona:** üë®‚Äçüíº GERENTE\n\n**Agrega√ß√£o:**\n- Soma todos os fechamentos di√°rios do m√™s\n- Calcula receita, despesas, comiss√µes\n- Identifica diverg√™ncias\n\n**Testes:** 6 assertions"
					},
					"response": []
				},
				{
					"name": "3.2 Fechar M√™s",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Status mudou para \"fechado\"', function() {",
									"    pm.expect(json.status).to.eql('fechado');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/mes/{{fechamento_mensal_id}}/fechar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "mes", "{{fechamento_mensal_id}}", "fechar"]
						}
					},
					"response": []
				},
				{
					"name": "3.3 Aprovar M√™s (Libera Comiss√µes)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"const json = pm.response.json();",
									"",
									"pm.test('Status final √© \"aprovado\"', function() {",
									"    pm.expect(json.status).to.eql('aprovado');",
									"});",
									"",
									"console.log('‚úÖ Fechamento mensal APROVADO - comiss√µes liberadas para pagamento');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{gerente_token}}"
							},
							{
								"key": "X-Tenant-Id",
								"value": "{{tenantId}}"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/v1/fechamento/mes/{{fechamento_mensal_id}}/aprovar",
							"host": ["{{baseUrl}}"],
							"path": ["v1", "fechamento", "mes", "{{fechamento_mensal_id}}", "aprovar"]
						},
						"description": "**RN06 + RN04:** Aprova√ß√£o mensal libera workflow de comiss√µes\n\n**Trigger:** Comiss√µes PENDENTES ‚Üí dispon√≠veis para aprova√ß√£o\n\n**Testes:** 2 assertions"
					},
					"response": []
				}
			],
			"description": "**Jornada:** Consolida√ß√£o mensal com libera√ß√£o de comiss√µes\n\n**Persona:** GERENTE\n**Total de Testes:** ~8 assertions"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script global de pr√©-requisi√ß√£o",
					"console.log('üöÄ Executando requisi√ß√£o:', pm.info.requestName);",
					"",
					"// Validar se token est√° presente (exceto para auth)",
					"if (!pm.info.requestName.includes('Auth')) {",
					"    const token = pm.environment.get('gerente_token') || ",
					"                  pm.environment.get('operador_token') || ",
					"                  pm.environment.get('financeiro_token');",
					"    ",
					"    if (!token) {",
					"        console.warn('‚ö†Ô∏è Nenhum token encontrado - execute Setup primeiro');",
					"    }",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script global de testes",
					"pm.test('Response time √© aceit√°vel', function() {",
					"    pm.expect(pm.response.responseTime).to.be.below(5000);",
					"});",
					"",
					"pm.test('N√£o possui erros 5xx', function() {",
					"    pm.expect(pm.response.code).to.be.below(500);",
					"});"
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:8090/api",
			"type": "string"
		},
		{
			"key": "tenantId",
			"value": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
			"type": "string"
		},
		{
			"key": "keycloakUrl",
			"value": "http://localhost:8081",
			"type": "string"
		},
		{
			"key": "modelo_id",
			"value": "33333333-3333-3333-3333-333333333333",
			"type": "string"
		},
		{
			"key": "jetski_id",
			"value": "44444444-4444-4444-4444-444444444444",
			"type": "string"
		}
	]
}
