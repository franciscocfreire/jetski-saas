{
  "info": {
    "_postman_id": "jetski-saas-api-v1",
    "name": "Jetski SaaS API",
    "description": "Collection para testes manuais da API Jetski SaaS multi-tenant.\n\n## Configura√ß√£o Inicial\n\n1. Importe os 4 ambientes (local, dev, hml, prd) dispon√≠veis na pasta `postman/environments/`\n2. Selecione o ambiente desejado no dropdown do Postman\n3. Execute o request \"Get Access Token\" para obter o JWT\n4. O token ser√° automaticamente salvo na vari√°vel `access_token` do ambiente\n5. Todos os requests protegidos usar√£o automaticamente este token\n\n## Multi-tenancy\n\nTodos os endpoints (exceto p√∫blicos e autentica√ß√£o) requerem:\n- **Authorization**: Bearer token JWT\n- **X-Tenant-Id**: UUID do tenant (configurado na vari√°vel `tenant_id` do ambiente)\n\n## Estrutura\n\n- **Auth**: Obten√ß√£o de tokens JWT via Keycloak\n- **User**: Gerenciamento de usu√°rios e listagem de tenants\n- **User Invitation**: Convidar e ativar usu√°rios (fluxo OIDC completo)\n- **Auth Tests**: Endpoints de teste para valida√ß√£o de seguran√ßa (RBAC, OPA)\n- **Health**: Health checks e m√©tricas\n\n## User Invitation Flow (OIDC)\n\n**Novo fluxo com Keycloak OIDC:**\n1. ADMIN_TENANT convida usu√°rio ‚Üí gera token (48h)\n2. Usu√°rio ativa conta (sem senha) ‚Üí criado no Keycloak com required action UPDATE_PASSWORD\n3. Email enviado com link de login\n4. Usu√°rio faz login ‚Üí Keycloak solicita defini√ß√£o de senha\n5. Usu√°rio define senha e est√° autenticado!\n\nVer documenta√ß√£o completa: `backend/OIDC_ACTIVATION_FLOW.md`\n\n## Infraestrutura\n\n**OPA (Open Policy Agent):** v1.9.0  \nPolicies modernizadas com sintaxe Rego v1 (upgrade em 2025-10-20)\n\n## Versionamento\n\nEsta collection √© **viva** e ser√° atualizada conforme novos endpoints forem adicionados.\n\nVers√£o: 1.2.1\n√öltima atualiza√ß√£o: 2025-10-20",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "jetski-team"
  },
  "item": [
    {
      "name": "Auth",
      "description": "Endpoints de autentica√ß√£o via Keycloak OAuth2/OIDC",
      "item": [
        {
          "name": "Get Access Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Salva o access_token na vari√°vel de ambiente",
                  "if (pm.response.code === 200) {",
                  "    const jsonData = pm.response.json();",
                  "    pm.environment.set(\"access_token\", jsonData.access_token);",
                  "    pm.environment.set(\"refresh_token\", jsonData.refresh_token);",
                  "    pm.environment.set(\"token_expires_in\", jsonData.expires_in);",
                  "    ",
                  "    console.log(\"‚úÖ Access token obtido com sucesso!\");",
                  "    console.log(\"Expira em:\", jsonData.expires_in, \"segundos\");",
                  "} else {",
                  "    console.error(\"‚ùå Erro ao obter token:\", pm.response.text());",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Valida√ß√£o de vari√°veis necess√°rias",
                  "const requiredVars = [\"keycloak_url\", \"keycloak_realm\", \"client_id\", \"client_secret\", \"username\", \"password\"];",
                  "const missing = requiredVars.filter(v => !pm.environment.get(v));",
                  "",
                  "if (missing.length > 0) {",
                  "    console.error(\"‚ùå Vari√°veis de ambiente ausentes:\", missing);",
                  "    throw new Error(\"Configure as vari√°veis: \" + missing.join(\", \"));",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded",
                "type": "text"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "grant_type",
                  "value": "password",
                  "type": "text"
                },
                {
                  "key": "client_id",
                  "value": "{{client_id}}",
                  "type": "text"
                },
                {
                  "key": "client_secret",
                  "value": "{{client_secret}}",
                  "type": "text"
                },
                {
                  "key": "username",
                  "value": "{{username}}",
                  "type": "text"
                },
                {
                  "key": "password",
                  "value": "{{password}}",
                  "type": "text"
                },
                {
                  "key": "scope",
                  "value": "openid profile email",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{keycloak_url}}/realms/{{keycloak_realm}}/protocol/openid-connect/token",
              "host": [
                "{{keycloak_url}}"
              ],
              "path": [
                "realms",
                "{{keycloak_realm}}",
                "protocol",
                "openid-connect",
                "token"
              ]
            },
            "description": "Obt√©m um access token JWT do Keycloak usando Resource Owner Password Credentials.\n\n**Vari√°veis necess√°rias:**\n- `keycloak_url`: URL base do Keycloak\n- `keycloak_realm`: Nome do realm\n- `client_id`: Client ID configurado no Keycloak\n- `client_secret`: Client secret (confidential client)\n- `username`: Usu√°rio para login\n- `password`: Senha do usu√°rio\n\n**Resposta:**\nO token JWT ser√° salvo automaticamente na vari√°vel `access_token`."
          },
          "response": []
        },
        {
          "name": "Refresh Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const jsonData = pm.response.json();",
                  "    pm.environment.set(\"access_token\", jsonData.access_token);",
                  "    pm.environment.set(\"refresh_token\", jsonData.refresh_token);",
                  "    pm.environment.set(\"token_expires_in\", jsonData.expires_in);",
                  "    console.log(\"‚úÖ Token renovado com sucesso!\");",
                  "} else {",
                  "    console.error(\"‚ùå Erro ao renovar token:\", pm.response.text());",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "grant_type",
                  "value": "refresh_token",
                  "type": "text"
                },
                {
                  "key": "client_id",
                  "value": "{{client_id}}",
                  "type": "text"
                },
                {
                  "key": "client_secret",
                  "value": "{{client_secret}}",
                  "type": "text"
                },
                {
                  "key": "refresh_token",
                  "value": "{{refresh_token}}",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{keycloak_url}}/realms/{{keycloak_realm}}/protocol/openid-connect/token",
              "host": [
                "{{keycloak_url}}"
              ],
              "path": [
                "realms",
                "{{keycloak_realm}}",
                "protocol",
                "openid-connect",
                "token"
              ]
            },
            "description": "Renova o access token usando o refresh token.\n\nUse quando o access token expirar (geralmente ap√≥s 5-15 minutos)."
          },
          "response": []
        }
      ]
    },
    {
      "name": "User",
      "description": "Endpoints relacionados a usu√°rios e tenants",
      "item": [
        {
          "name": "List User Tenants",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has access_type\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"access_type\");",
                  "    pm.expect(jsonData.access_type).to.be.oneOf([\"LIMITED\", \"UNRESTRICTED\"]);",
                  "});",
                  "",
                  "pm.test(\"If LIMITED, should have tenants array\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    if (jsonData.access_type === \"LIMITED\") {",
                  "        pm.expect(jsonData).to.have.property(\"tenants\");",
                  "        pm.expect(jsonData.tenants).to.be.an(\"array\");",
                  "        pm.expect(jsonData).to.have.property(\"total_count\");",
                  "    }",
                  "});",
                  "",
                  "// Salva o primeiro tenant_id para uso em outros requests",
                  "const jsonData = pm.response.json();",
                  "if (jsonData.access_type === \"LIMITED\" && jsonData.tenants && jsonData.tenants.length > 0) {",
                  "    const firstTenantId = jsonData.tenants[0].tenant.id;",
                  "    pm.environment.set(\"tenant_id\", firstTenantId);",
                  "    console.log(\"‚úÖ Primeiro tenant_id salvo:\", firstTenantId);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/v1/user/tenants",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "user",
                "tenants"
              ]
            },
            "description": "Lista todos os tenants que o usu√°rio autenticado pode acessar.\n\n**Tipos de resposta:**\n- `LIMITED`: Retorna lista de tenants (m√°x 100)\n- `UNRESTRICTED`: Usu√°rio √© admin de plataforma, pode acessar qualquer tenant\n\n**Uso:**\n- Mobile app: Exibir seletor de tenant no login\n- Web app: Exibir dropdown de tenants"
          },
          "response": []
        }
      ]
    },
    {
      "name": "User Invitation",
      "description": "Endpoints para convidar e ativar usu√°rios no tenant.\n\n**Fluxo Option 2 (Temporary Password):**\n1. ADMIN_TENANT convida usu√°rio ‚Üí backend gera senha tempor√°ria aleat√≥ria (12 chars)\n2. Backend armazena hash BCrypt da senha tempor√°ria\n3. Email enviado com token + senha tempor√°ria em texto plano\n4. Usu√°rio ativa conta com token + senha tempor√°ria (endpoint p√∫blico)\n5. Backend valida senha tempor√°ria contra hash BCrypt\n6. Cria usu√°rio no PostgreSQL + Keycloak com senha tempor√°ria + required action UPDATE_PASSWORD\n7. Usu√°rio faz primeiro login com senha tempor√°ria\n8. Keycloak FOR√áA troca de senha (pol√≠ticas gerenciadas pelo Keycloak)\n9. Usu√°rio define senha permanente e est√° autenticado!",
      "item": [
        {
          "name": "Invite User to Tenant",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has conviteId\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"conviteId\");",
                  "    pm.expect(jsonData).to.have.property(\"email\");",
                  "    pm.expect(jsonData).to.have.property(\"expiresAt\");",
                  "});",
                  "",
                  "// Salva dados para teste de ativa√ß√£o",
                  "const jsonData = pm.response.json();",
                  "if (jsonData.conviteId) {",
                  "    // Token n√£o √© retornado na API (s√≥ via email), mas podemos buscar no DB para testes",
                  "    console.log(\"‚úÖ Convite criado:\", jsonData.conviteId);",
                  "    console.log(\"   Email:\", jsonData.email);",
                  "    console.log(\"   Expira em:\", jsonData.expiresAt);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"operador.novo@example.com\",\n  \"nome\": \"Operador Novo\",\n  \"papeis\": [\"OPERADOR\"]\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{api_url}}/v1/tenants/{{tenant_id}}/users/invite",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "tenants",
                "{{tenant_id}}",
                "users",
                "invite"
              ]
            },
            "description": "Convida um novo usu√°rio para o tenant.\n\n**Requer:** ADMIN_TENANT ou GERENTE role\n\n**Valida√ß√µes:**\n- Limite de usu√°rios do plano n√£o atingido\n- Email n√£o possui convite pendente\n- Email n√£o √© membro do tenant\n\n**Resposta:**\n- Convite criado com token v√°lido por 48h\n- Email de convite enviado (TODO)\n\n**Body:**\n```json\n{\n  \"email\": \"novo.usuario@example.com\",\n  \"nome\": \"Novo Usu√°rio\",\n  \"papeis\": [\"OPERADOR\", \"VENDEDOR\"]\n}\n```\n\n**Roles dispon√≠veis:**\n- ADMIN_TENANT\n- GERENTE\n- OPERADOR\n- VENDEDOR\n- MECANICO\n- FINANCEIRO"
          },
          "response": []
        }
      ]
    },
    {
      "name": "User Invitation (Single-Email Flow)",
      "description": "FLUXO OPTION 2: Ativa√ß√£o com senha tempor√°ria em um √∫nico email.\n\n**Fluxo Completo:**\n1. ADMIN_TENANT convida usu√°rio ‚Üí backend gera senha tempor√°ria aleat√≥ria (12 chars)\n2. Backend armazena hash BCrypt da senha tempor√°ria no BD\n3. Email enviado com: link de ativa√ß√£o + senha tempor√°ria em texto plano\n   - Link: /activate?token=xxx\n   - Senha tempor√°ria: Ab12#Xy9@Kl4 (exemplo)\n4. Usu√°rio acessa formul√°rio de ativa√ß√£o e informa: token + senha tempor√°ria do email\n5. POST /v1/auth/complete-activation (token + temporaryPassword)\n6. Backend valida senha tempor√°ria contra hash BCrypt\n7. Se v√°lido: cria usu√°rio no PostgreSQL + Keycloak com senha tempor√°ria + required action UPDATE_PASSWORD\n8. Usu√°rio faz primeiro login com senha tempor√°ria\n9. Keycloak FOR√áA troca de senha (pol√≠ticas gerenciadas pelo Keycloak: comprimento, complexidade, hist√≥rico)\n10. Usu√°rio define senha permanente e est√° autenticado!\n\n**Vantagens:**\n- UX simplificado: 1 √∫nico email\n- Seguran√ßa: senha tempor√°ria aleat√≥ria gerada pelo backend\n- Keycloak gerencia pol√≠ticas de senha (n√£o o frontend/backend)\n- For√ßar troca no primeiro login garante senha conhecida apenas pelo usu√°rio",
      "item": [
        {
          "name": "1. Invite User to Tenant",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has conviteId\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"conviteId\");",
                  "    pm.expect(jsonData).to.have.property(\"email\");",
                  "    pm.expect(jsonData).to.have.property(\"expiresAt\");",
                  "});",
                  "",
                  "// Salva email para pr√≥ximos testes",
                  "const jsonData = pm.response.json();",
                  "if (jsonData.email) {",
                  "    pm.environment.set(\"invited_email\", jsonData.email);",
                  "    console.log(\"‚úÖ Convite criado (Option 2):\", jsonData.conviteId);",
                  "    console.log(\"   Email:\", jsonData.email);",
                  "    console.log(\"   Expira em:\", jsonData.expiresAt);",
                  "    console.log(\"\");",
                  "    console.log(\"üîî IMPORTANTE: Busque token E senha tempor√°ria no email\");",
                  "    console.log(\"   Local: /tmp/emails/ (arquivo mais recente)\");",
                  "    console.log(\"   Token: na URL do link de ativa√ß√£o\");",
                  "    console.log(\"   Senha tempor√°ria: no corpo do email (12 chars aleat√≥rios)\");",
                  "    console.log(\"   Ou via SQL: SELECT token FROM convite WHERE email = '\" + jsonData.email + \"' AND status = 'PENDING';\");",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"teste.fluxo.unico@example.com\",\n  \"nome\": \"Teste Fluxo √önico\",\n  \"papeis\": [\"OPERADOR\"]\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{api_url}}/v1/tenants/{{tenant_id}}/users/invite",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "tenants",
                "{{tenant_id}}",
                "users",
                "invite"
              ]
            },
            "description": "**Passo 1:** Convida usu√°rio para o tenant (Option 2 flow).\n\n**Requer:** ADMIN_TENANT ou GERENTE\n\n**A√ß√£o:**\n- Email de convite enviado para `teste.fluxo.unico@example.com`\n- Email cont√©m:\n  - Link de ativa√ß√£o: `{{frontend_url}}/activate?token=xxx`\n  - Senha tempor√°ria aleat√≥ria gerada pelo backend (12 chars)\n- Token v√°lido por 48 horas\n\n**Backend (Option 2):**\n- Gera senha tempor√°ria aleat√≥ria: `SecureRandom` (12 chars)\n- Armazena hash BCrypt no campo `temporary_password_hash`\n- Envia senha tempor√°ria em texto plano NO EMAIL (√∫nica vez)\n\n**Pr√≥ximos passos:**\n1. Verifique o email em `/tmp/emails/` (√∫ltimo arquivo criado)\n2. Copie o token da URL\n3. Copie a senha tempor√°ria do corpo do email\n4. Cole ambos no request \"2. Complete Activation with Password\"\n5. Execute para ativar conta com senha tempor√°ria validada via BCrypt\n6. Execute \"3. Login with New User\" com senha tempor√°ria para validar"
          },
          "response": []
        },
        {
          "name": "2. Complete Activation with Password",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has usuarioId\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"usuarioId\");",
                  "    pm.expect(jsonData).to.have.property(\"email\");",
                  "    pm.expect(jsonData).to.have.property(\"tenantId\");",
                  "    pm.expect(jsonData).to.have.property(\"roles\");",
                  "});",
                  "",
                  "pm.test(\"Success message indicates immediate login\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.include(\"fazer login\");",
                  "});",
                  "",
                  "const jsonData = pm.response.json();",
                  "console.log(\"‚úÖ Conta ativada COM SENHA TEMPOR√ÅRIA (Option 2):\", jsonData.usuarioId);",
                  "console.log(\"   Email:\", jsonData.email);",
                  "console.log(\"   Tenant:\", jsonData.tenantId);",
                  "console.log(\"   Roles:\", jsonData.roles.join(\", \"));",
                  "console.log(\"   Mensagem:\", jsonData.message);",
                  "console.log(\"\");",
                  "console.log(\"üéâ Usu√°rio pode fazer login com senha tempor√°ria!\");",
                  "console.log(\"   Execute o request '3. Login with New User' para testar\");",
                  "console.log(\"   ‚ö†Ô∏è  Keycloak for√ßar√° troca de senha no primeiro login\");"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"token\": \"COLE-O-TOKEN-DO-EMAIL-AQUI\",\n  \"temporaryPassword\": \"COLE-A-SENHA-TEMPORARIA-DO-EMAIL-AQUI\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{api_url}}/v1/auth/complete-activation",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth",
                "complete-activation"
              ]
            },
            "description": "**Passo 2:** Completa ativa√ß√£o da conta com SENHA TEMPOR√ÅRIA (Option 2 flow).\n\n**Endpoint P√öBLICO** - N√£o requer autentica√ß√£o\n\n**Fluxo:**\n1. Usu√°rio recebe email com: token + senha tempor√°ria (gerada pelo backend)\n2. Frontend exibe formul√°rio: token + temporaryPassword\n3. Submit ‚Üí POST /v1/auth/complete-activation\n4. Backend:\n   - Valida token (n√£o expirado, status PENDING)\n   - Valida senha tempor√°ria contra hash BCrypt armazenado\n   - Cria usuario no PostgreSQL (email_verified=true)\n   - Cria membro no tenant\n   - Cria usuario no Keycloak com senha tempor√°ria + required action UPDATE_PASSWORD\n   - Marca convite como ACTIVATED\n5. Usu√°rio faz primeiro login com senha tempor√°ria\n6. Keycloak FOR√áA troca de senha (pol√≠ticas gerenciadas pelo Keycloak)\n7. Usu√°rio define senha permanente e est√° autenticado!\n\n**Body (Option 2):**\n```json\n{\n  \"token\": \"abc123xyz...\",\n  \"temporaryPassword\": \"Ab12#Xy9@Kl4\"\n}\n```\n\n**Valida√ß√µes:**\n- Token v√°lido e n√£o expirado (48h)\n- Token em status PENDING (n√£o usado)\n- Senha tempor√°ria v√°lida (match com hash BCrypt)\n- Email n√£o duplicado\n\n**Para obter token e senha tempor√°ria:**\n1. Verifique arquivo em `/tmp/emails/` (√∫ltimo criado)\n2. Busque o token na URL e a senha tempor√°ria no corpo do email\n3. Cole ambos no body do request\n\n**Ou via SQL (apenas token):**\n```sql\nSELECT token FROM convite \nWHERE email = 'teste.fluxo.unico@example.com' \nAND status = 'PENDING' \nORDER BY created_at DESC LIMIT 1;\n```\n\n**Seguran√ßa Option 2:**\n- Backend gera senha tempor√°ria aleat√≥ria (12 chars)\n- Armazena apenas hash BCrypt no banco\n- Senha tempor√°ria enviada UMA VEZ no email\n- Keycloak for√ßa troca no primeiro login\n- Pol√≠ticas de senha gerenciadas pelo Keycloak (comprimento, complexidade, hist√≥rico)"
          },
          "response": []
        },
        {
          "name": "3. Magic Link Activation (One-Click UX)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has usuarioId\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"usuarioId\");",
                  "    pm.expect(jsonData).to.have.property(\"email\");",
                  "    pm.expect(jsonData).to.have.property(\"tenantId\");",
                  "    pm.expect(jsonData).to.have.property(\"roles\");",
                  "});",
                  "",
                  "pm.test(\"Success message indicates immediate login\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.include(\"fazer login\");",
                  "});",
                  "",
                  "const jsonData = pm.response.json();",
                  "console.log(\"‚úÖ Conta ativada VIA MAGIC LINK (One-Click):\", jsonData.usuarioId);",
                  "console.log(\"   Email:\", jsonData.email);",
                  "console.log(\"   Tenant:\", jsonData.tenantId);",
                  "console.log(\"   Roles:\", jsonData.roles.join(\", \"));",
                  "console.log(\"   Mensagem:\", jsonData.message);",
                  "console.log(\"\");",
                  "console.log(\"üéâ MAGIC LINK FUNCIONOU - Sem digita√ß√£o de senha!\");",
                  "console.log(\"   Usu√°rio pode fazer login com senha tempor√°ria\");",
                  "console.log(\"   Execute o request '4. Login with New User' para testar\");",
                  "console.log(\"   ‚ö†Ô∏è  Keycloak for√ßar√° troca de senha no primeiro login\");"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"magicToken\": \"COLE-O-JWT-DO-EMAIL-AQUI\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{api_url}}/v1/auth/magic-activate",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth",
                "magic-activate"
              ]
            },
            "description": "**Passo 3 (Alternativa): Ativa√ß√£o via Magic Link JWT (UX melhorada - ONE CLICK!)**\n\n**Endpoint P√öBLICO** - N√£o requer autentica√ß√£o\n\n**O que √© Magic Link?**\nMagic Link √© um JWT assinado que cont√©m o token de convite + senha tempor√°ria criptografados. O usu√°rio s√≥ precisa clicar no link do email - sem digitar nada!\n\n**Fluxo:**\n1. Usu√°rio recebe email com magic link: `{{frontend_url}}/magic-activate?token=SIGNED_JWT`\n2. Usu√°rio CLICA NO LINK (sem precisar digitar nada!)\n3. Frontend extrai JWT da URL e envia para este endpoint\n4. Backend:\n   - Valida assinatura do JWT (HMAC-SHA256)\n   - Valida expira√ß√£o (48h)\n   - Extrai invitation token + senha tempor√°ria do JWT\n   - Chama o fluxo de ativa√ß√£o normal (mesmo que endpoint #2)\n5. Conta ativada! Usu√°rio pode fazer login com senha tempor√°ria\n6. Keycloak for√ßa troca de senha no primeiro login\n\n**Body (Magic Link):**\n```json\n{\n  \"magicToken\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}\n```\n\n**JWT Claims (dentro do magicToken):**\n- `sub`: invitation token (string 40 chars)\n- `pwd`: senha tempor√°ria (plain text, criptografada no JWT)\n- `exp`: expira√ß√£o (48 horas)\n- `iat`: issued at\n- `jti`: JWT ID √∫nico\n\n**Valida√ß√µes:**\n- JWT com assinatura v√°lida (n√£o foi adulterado)\n- JWT n√£o expirado (48h)\n- Invitation token v√°lido e n√£o usado\n- Senha tempor√°ria v√°lida (extra√≠da do JWT)\n\n**Para obter o Magic Token:**\n1. Verifique arquivo em `/tmp/emails/` (√∫ltimo criado)\n2. Busque o JWT completo ap√≥s \"magic-activate?token=\"\n3. Cole o JWT inteiro no campo `magicToken` do body\n\n**Seguran√ßa Magic Link:**\n- JWT assinado com HMAC-SHA256 (n√£o pode ser forjado)\n- Senha tempor√°ria nunca armazenada em plain text no banco\n- JWT expira em 48h (mesma validade do convite)\n- Token s√≥ pode ser usado uma vez (convite √© marcado como ACTIVATED)\n- Keycloak for√ßa troca de senha no primeiro login\n\n**Diferen√ßa entre Magic Link (#3) e Ativa√ß√£o Manual (#2):**\n- **#2 (Manual)**: Usu√°rio digita token + senha tempor√°ria no formul√°rio\n- **#3 (Magic Link)**: Usu√°rio clica no link - ZERO digita√ß√£o! ‚ú®\n- Ambos ativam a conta da mesma forma, diferen√ßa √© apenas UX\n\n**Vantagens Magic Link:**\n- ‚úÖ UX perfeita: um clique ativa a conta\n- ‚úÖ Menos erros: usu√°rio n√£o precisa copiar/colar nada\n- ‚úÖ Mobile-friendly: funciona perfeitamente em smartphones\n- ‚úÖ Seguran√ßa mantida: JWT assinado + senha tempor√°ria criptografada"
          },
          "response": []
        },
        {
          "name": "4. Login with New User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has access_token\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"access_token\");",
                  "    pm.expect(jsonData).to.have.property(\"refresh_token\");",
                  "    pm.expect(jsonData).to.have.property(\"id_token\");",
                  "});",
                  "",
                  "// Salva tokens",
                  "if (pm.response.code === 200) {",
                  "    const jsonData = pm.response.json();",
                  "    pm.environment.set(\"new_user_token\", jsonData.access_token);",
                  "    console.log(\"‚úÖ LOGIN BEM-SUCEDIDO COM SENHA TEMPOR√ÅRIA (Option 2)!\");",
                  "    console.log(\"   Access token obtido e salvo em 'new_user_token'\");",
                  "    console.log(\"   Token expira em:\", jsonData.expires_in, \"segundos\");",
                  "    console.log(\"\");",
                  "    console.log(\"üéâ FLUXO OPTION 2 COMPLETO!\");",
                  "    console.log(\"   ‚úì Convite enviado com senha tempor√°ria aleat√≥ria\");",
                  "    console.log(\"   ‚úì Conta ativada com senha tempor√°ria validada via BCrypt\");",
                  "    console.log(\"   ‚úì Login com senha tempor√°ria funcionando\");",
                  "    console.log(\"   ‚ö†Ô∏è  Keycloak for√ßar√° troca de senha no primeiro login (Authorization Code Flow)\");",
                  "} else {",
                  "    console.error(\"‚ùå Falha no login - verifique email/senha\");",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "grant_type",
                  "value": "password",
                  "type": "text"
                },
                {
                  "key": "client_id",
                  "value": "{{client_id}}",
                  "type": "text"
                },
                {
                  "key": "client_secret",
                  "value": "{{client_secret}}",
                  "type": "text"
                },
                {
                  "key": "username",
                  "value": "teste.fluxo.unico@example.com",
                  "type": "text",
                  "description": "Email do usu√°rio convidado"
                },
                {
                  "key": "password",
                  "value": "SENHA-TEMPORARIA-DO-EMAIL",
                  "type": "text",
                  "description": "Senha tempor√°ria do email (gerada pelo backend no passo 1)"
                },
                {
                  "key": "scope",
                  "value": "openid profile email",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{keycloak_url}}/realms/{{keycloak_realm}}/protocol/openid-connect/token",
              "host": [
                "{{keycloak_url}}"
              ],
              "path": [
                "realms",
                "{{keycloak_realm}}",
                "protocol",
                "openid-connect",
                "token"
              ]
            },
            "description": "**Passo 3:** Faz login com o usu√°rio rec√©m-criado (Option 2: primeiro login com senha tempor√°ria).\n\n**IMPORTANTE - Fluxo Option 2:**\n- Este teste simula o primeiro login do usu√°rio com senha tempor√°ria\n- **Keycloak FOR√áAR√Å troca de senha** (required action UPDATE_PASSWORD)\n- Em ambiente real, Keycloak redirecionar√° para tela de altera√ß√£o de senha\n- Ap√≥s troca, usu√°rio ter√° senha permanente conhecida apenas por ele\n\n**Credenciais:**\n- username: `teste.fluxo.unico@example.com`\n- password: **senha tempor√°ria do email** (ex: `Ab12#Xy9@Kl4`)\n\n**O que este teste valida:**\n1. Usu√°rio foi criado corretamente no Keycloak\n2. Senha tempor√°ria foi definida e √© funcional\n3. Email foi marcado como verificado\n4. Required action UPDATE_PASSWORD est√° ativo\n5. Login com senha tempor√°ria funciona\n\n**Nota:** \n- Neste teste via Postman, o login via Resource Owner Password Credentials pode n√£o enforcar o UPDATE_PASSWORD\n- Em aplica√ß√£o real (Authorization Code Flow), Keycloak for√ßa troca de senha ap√≥s login\n- Pol√≠ticas de senha (comprimento, complexidade, hist√≥rico) s√£o gerenciadas pelo Keycloak\n\n**Se falhar:**\n- Verifique se o passo 2 retornou 200\n- Use a senha tempor√°ria do email (n√£o a senha permanente)\n- Cheque logs do backend em /tmp/backend-*.log"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Tenant Members",
      "description": "Endpoints para gerenciamento de membros do tenant.\n\n**Funcionalidades:**\n- Listar membros ativos/inativos\n- Ver informa√ß√µes de limite do plano\n- Desativar membros (soft delete)\n\n**Requer:** ADMIN_TENANT ou GERENTE role",
      "item": [
        {
          "name": "List Tenant Members",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has members array\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"members\");",
                  "    pm.expect(jsonData.members).to.be.an(\"array\");",
                  "});",
                  "",
                  "pm.test(\"Response has plan limit info\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"planLimit\");",
                  "    pm.expect(jsonData.planLimit).to.have.property(\"maxUsuarios\");",
                  "    pm.expect(jsonData.planLimit).to.have.property(\"currentActive\");",
                  "    pm.expect(jsonData.planLimit).to.have.property(\"available\");",
                  "});",
                  "",
                  "const jsonData = pm.response.json();",
                  "console.log(\"‚úÖ Members loaded:\", jsonData.totalCount);",
                  "console.log(\"   Active:\", jsonData.activeCount);",
                  "console.log(\"   Inactive:\", jsonData.inactiveCount);",
                  "console.log(\"   Plan limit:\", jsonData.planLimit.currentActive + \"/\" + jsonData.planLimit.maxUsuarios);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/tenants/{{tenant_id}}/members?includeInactive=false",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "tenants",
                "{{tenant_id}}",
                "members"
              ],
              "query": [
                {
                  "key": "includeInactive",
                  "value": "false",
                  "description": "Incluir membros inativos (default: false)"
                }
              ]
            },
            "description": "Lista todos os membros do tenant com informa√ß√µes de limite do plano.\n\n**Requer:** ADMIN_TENANT ou GERENTE role\n\n**Query Parameters:**\n- `includeInactive`: boolean (default: false) - Incluir membros inativos\n\n**Response:**\n```json\n{\n  \"members\": [\n    {\n      \"usuarioId\": \"uuid\",\n      \"email\": \"user@example.com\",\n      \"nome\": \"Nome do Usu√°rio\",\n      \"papeis\": [\"GERENTE\", \"OPERADOR\"],\n      \"ativo\": true,\n      \"joinedAt\": \"2025-01-15T10:30:00Z\",\n      \"lastUpdated\": \"2025-01-15T10:30:00Z\"\n    }\n  ],\n  \"totalCount\": 10,\n  \"activeCount\": 8,\n  \"inactiveCount\": 2,\n  \"planLimit\": {\n    \"maxUsuarios\": 10,\n    \"currentActive\": 8,\n    \"available\": 2,\n    \"limitReached\": false\n  }\n}\n```"
          },
          "response": []
        },
        {
          "name": "Deactivate Member",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response indicates success\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.message).to.include(\"desativado com sucesso\");",
                  "});",
                  "",
                  "const jsonData = pm.response.json();",
                  "console.log(\"‚úÖ Member deactivated:\", jsonData.usuarioId);",
                  "console.log(\"   Email:\", jsonData.email);",
                  "console.log(\"   Tenant:\", jsonData.tenantId);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "DELETE",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/tenants/{{tenant_id}}/members/{{usuario_id_to_deactivate}}",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "tenants",
                "{{tenant_id}}",
                "members",
                "{{usuario_id_to_deactivate}}"
              ]
            },
            "description": "Desativa um membro do tenant (soft delete).\n\n**Requer:** ADMIN_TENANT ou GERENTE role\n\n**Valida√ß√µes:**\n- Membro deve existir e estar ativo\n- N√£o pode desativar o √∫ltimo ADMIN_TENANT do tenant\n\n**Path Parameters:**\n- `tenantId`: UUID do tenant\n- `usuarioId`: UUID do usu√°rio a desativar\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Membro desativado com sucesso\",\n  \"usuarioId\": \"uuid\",\n  \"email\": \"user@example.com\",\n  \"tenantId\": \"uuid\"\n}\n```\n\n**Errors:**\n- 404: Membro n√£o encontrado\n- 400: Membro j√° est√° inativo\n- 400: N√£o √© poss√≠vel desativar o √∫ltimo ADMIN_TENANT\n\n**Exemplo:**\n1. Execute \"List Tenant Members\" para ver membros\n2. Copie o `usuarioId` de um membro de teste\n3. Crie vari√°vel `usuario_id_to_deactivate` com esse UUID\n4. Execute este endpoint"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Auth Tests",
      "description": "Endpoints de teste para valida√ß√£o de seguran√ßa (RBAC, OPA, multi-tenancy)\n\n‚ö†Ô∏è **IMPORTANTE**: Estes endpoints s√£o apenas para testes e devem ser removidos em produ√ß√£o.",
      "item": [
        {
          "name": "Public Endpoint",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has message\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"message\");",
                  "    pm.expect(jsonData.message).to.include(\"Public endpoint\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/v1/auth-test/public",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "public"
              ]
            },
            "description": "Endpoint p√∫blico sem autentica√ß√£o.\n\nUse para testar conectividade com a API."
          },
          "response": []
        },
        {
          "name": "Get Current User (Me)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has authenticated=true\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.authenticated).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"Response has JWT claims\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"jwt\");",
                  "    pm.expect(jsonData.jwt).to.have.property(\"sub\");",
                  "    pm.expect(jsonData.jwt).to.have.property(\"email\");",
                  "});",
                  "",
                  "pm.test(\"Response has tenantId\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"tenantId\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/auth-test/me",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "me"
              ]
            },
            "description": "Retorna informa√ß√µes do usu√°rio autenticado extra√≠das do JWT.\n\n**Valida:**\n- Extra√ß√£o de claims do JWT (sub, email, roles, tenant_id)\n- Valida√ß√£o de tenant_id vs header X-Tenant-Id\n- Authorities (roles) do Spring Security"
          },
          "response": []
        },
        {
          "name": "Operador Only",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Se o usu√°rio tem role OPERADOR, deve retornar 200",
                  "// Caso contr√°rio, deve retornar 403 Forbidden",
                  "",
                  "if (pm.response.code === 200) {",
                  "    pm.test(\"User has OPERADOR role - Access granted\", function () {",
                  "        const jsonData = pm.response.json();",
                  "        pm.expect(jsonData.message).to.include(\"OPERADOR\");",
                  "    });",
                  "} else if (pm.response.code === 403) {",
                  "    pm.test(\"User does NOT have OPERADOR role - Access denied (expected)\", function () {",
                  "        pm.expect(pm.response.code).to.equal(403);",
                  "    });",
                  "} else {",
                  "    pm.test(\"Unexpected status code\", function () {",
                  "        pm.expect.fail(\"Expected 200 or 403, got \" + pm.response.code);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/auth-test/operador-only",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "operador-only"
              ]
            },
            "description": "Endpoint protegido que requer role **OPERADOR**.\n\n**Valida:**\n- @PreAuthorize com single role\n- 403 Forbidden se usu√°rio n√£o tem a role"
          },
          "response": []
        },
        {
          "name": "Manager Only",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    pm.test(\"User has GERENTE or ADMIN_TENANT role - Access granted\", function () {",
                  "        const jsonData = pm.response.json();",
                  "        pm.expect(jsonData.message).to.include(\"GERENTE\");",
                  "    });",
                  "} else if (pm.response.code === 403) {",
                  "    pm.test(\"User does NOT have required roles - Access denied (expected)\", function () {",
                  "        pm.expect(pm.response.code).to.equal(403);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/auth-test/manager-only",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "manager-only"
              ]
            },
            "description": "Endpoint protegido que requer role **GERENTE** ou **ADMIN_TENANT**.\n\n**Valida:**\n- @PreAuthorize com m√∫ltiplas roles (hasAnyRole)"
          },
          "response": []
        },
        {
          "name": "Finance Only",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    pm.test(\"User has FINANCEIRO role - Access granted\", function () {",
                  "        const jsonData = pm.response.json();",
                  "        pm.expect(jsonData.message).to.include(\"FINANCEIRO\");",
                  "    });",
                  "} else if (pm.response.code === 403) {",
                  "    pm.test(\"User does NOT have FINANCEIRO role - Access denied (expected)\", function () {",
                  "        pm.expect(pm.response.code).to.equal(403);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/auth-test/finance-only",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "finance-only"
              ]
            },
            "description": "Endpoint protegido que requer role **FINANCEIRO**."
          },
          "response": []
        },
        {
          "name": "OPA RBAC Test",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has decision\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"decision\");",
                  "    pm.expect(jsonData.decision).to.have.property(\"allow\");",
                  "    pm.expect(jsonData.decision).to.have.property(\"tenant_is_valid\");",
                  "});",
                  "",
                  "// Log resultado",
                  "const decision = pm.response.json().decision;",
                  "if (decision.allow) {",
                  "    console.log(\"‚úÖ OPA RBAC: Access ALLOWED\");",
                  "} else {",
                  "    console.log(\"‚ùå OPA RBAC: Access DENIED\");",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/auth-test/opa/rbac?action=locacao:checkin&role=OPERADOR",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "opa",
                "rbac"
              ],
              "query": [
                {
                  "key": "action",
                  "value": "locacao:checkin",
                  "description": "A√ß√£o a validar (ex: modelo:list, locacao:checkin)"
                },
                {
                  "key": "role",
                  "value": "OPERADOR",
                  "description": "Papel do usu√°rio (ex: OPERADOR, GERENTE)"
                },
                {
                  "key": "resourceTenantId",
                  "value": "",
                  "description": "Tenant do recurso (opcional, usa tenantId do user se omitido)",
                  "disabled": true
                }
              ]
            },
            "description": "Testa autoriza√ß√£o RBAC via OPA (Open Policy Agent).\n\n**Par√¢metros:**\n- `action`: A√ß√£o a validar (ex: modelo:list, locacao:checkin)\n- `role`: Papel do usu√°rio (ex: OPERADOR, GERENTE)\n- `resourceTenantId`: Tenant do recurso (opcional)\n\n**Exemplos de a√ß√µes:**\n- `modelo:list` - Listar modelos\n- `locacao:checkin` - Check-in de loca√ß√£o\n- `locacao:checkout` - Check-out de loca√ß√£o\n- `os:criar` - Criar ordem de servi√ßo"
          },
          "response": []
        },
        {
          "name": "OPA Al√ßada Test",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has decision with alcada fields\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.decision).to.have.property(\"allow\");",
                  "    pm.expect(jsonData.decision).to.have.property(\"requer_aprovacao\");",
                  "});",
                  "",
                  "// Log resultado",
                  "const decision = pm.response.json().decision;",
                  "console.log(\"OPA Al√ßada:\");",
                  "console.log(\"  Allow:\", decision.allow);",
                  "console.log(\"  Requer Aprova√ß√£o:\", decision.requer_aprovacao);",
                  "if (decision.aprovador_requerido !== \"N/A\") {",
                  "    console.log(\"  Aprovador Requerido:\", decision.aprovador_requerido);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{api_url}}/v1/auth-test/opa/alcada?action=desconto:aplicar&role=OPERADOR&percentualDesconto=15",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "opa",
                "alcada"
              ],
              "query": [
                {
                  "key": "action",
                  "value": "desconto:aplicar",
                  "description": "A√ß√£o (ex: desconto:aplicar, os:aprovar)"
                },
                {
                  "key": "role",
                  "value": "OPERADOR",
                  "description": "Papel do usu√°rio"
                },
                {
                  "key": "percentualDesconto",
                  "value": "15",
                  "description": "Percentual de desconto (para desconto:aplicar)"
                },
                {
                  "key": "valorOs",
                  "value": "",
                  "description": "Valor da OS (para os:aprovar)",
                  "disabled": true
                }
              ]
            },
            "description": "Testa pol√≠tica de Al√ßada (autoridade de aprova√ß√£o) via OPA.\n\n**Casos de uso:**\n- Aplicar desconto: Valida se usu√°rio pode aplicar X% de desconto\n- Aprovar OS: Valida se usu√°rio pode aprovar OS de R$ X\n\n**Par√¢metros:**\n- `action`: desconto:aplicar ou os:aprovar\n- `role`: Papel do usu√°rio\n- `percentualDesconto`: % de desconto (para desconto:aplicar)\n- `valorOs`: Valor da OS em reais (para os:aprovar)\n\n**Exemplos:**\n1. OPERADOR aplicar 10% desconto ‚Üí allow=true\n2. OPERADOR aplicar 25% desconto ‚Üí allow=false, requer_aprovacao=true, aprovador=GERENTE\n3. GERENTE aprovar OS de R$ 5.000 ‚Üí allow=true\n4. GERENTE aprovar OS de R$ 15.000 ‚Üí allow=false, requer_aprovacao=true, aprovador=ADMIN_TENANT"
          },
          "response": []
        },
        {
          "name": "OPA Generic Authorize",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has decision\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"decision\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{access_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "X-Tenant-Id",
                "value": "{{tenant_id}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"action\": \"locacao:checkin\",\n  \"user\": {\n    \"id\": \"550e8400-e29b-41d4-a716-446655440000\",\n    \"tenant_id\": \"{{tenant_id}}\",\n    \"role\": \"OPERADOR\"\n  },\n  \"resource\": {\n    \"id\": \"123e4567-e89b-12d3-a456-426614174000\",\n    \"tenant_id\": \"{{tenant_id}}\"\n  },\n  \"operation\": {\n    \"percentual_desconto\": null,\n    \"valor_os\": null\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{api_url}}/v1/auth-test/opa/authorize",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "v1",
                "auth-test",
                "opa",
                "authorize"
              ]
            },
            "description": "Testa autoriza√ß√£o gen√©rica (RBAC + Al√ßada) via OPA.\n\nEste endpoint combina:\n1. Valida√ß√£o RBAC (role tem permiss√£o?)\n2. Se sim e h√° contexto de opera√ß√£o, valida Al√ßada\n\n**Body:**\n```json\n{\n  \"action\": \"locacao:checkin\",\n  \"user\": {\n    \"id\": \"user-uuid\",\n    \"tenant_id\": \"tenant-uuid\",\n    \"role\": \"OPERADOR\"\n  },\n  \"resource\": {\n    \"id\": \"resource-uuid\",\n    \"tenant_id\": \"tenant-uuid\"\n  },\n  \"operation\": {\n    \"percentual_desconto\": 10,\n    \"valor_os\": 5000.00\n  }\n}\n```"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Health",
      "description": "Health checks e m√©tricas de observabilidade",
      "item": [
        {
          "name": "Health Check",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Status is UP\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.equal(\"UP\");",
                  "});",
                  "",
                  "pm.test(\"Has components\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"components\");",
                  "});",
                  "",
                  "// Verifica se PostgreSQL est√° UP",
                  "const components = pm.response.json().components;",
                  "if (components.db) {",
                  "    pm.test(\"Database is UP\", function () {",
                  "        pm.expect(components.db.status).to.equal(\"UP\");",
                  "    });",
                  "}",
                  "",
                  "// Verifica se Redis est√° UP (se configurado)",
                  "if (components.redis) {",
                  "    pm.test(\"Redis is UP\", function () {",
                  "        pm.expect(components.redis.status).to.equal(\"UP\");",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/actuator/health",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "actuator",
                "health"
              ]
            },
            "description": "Health check da aplica√ß√£o.\n\nRetorna status da aplica√ß√£o e seus componentes (database, redis, etc.)."
          },
          "response": []
        },
        {
          "name": "Metrics",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Has metrics\", function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property(\"names\");",
                  "    pm.expect(jsonData.names).to.be.an(\"array\");",
                  "    pm.expect(jsonData.names.length).to.be.greaterThan(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/actuator/metrics",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "actuator",
                "metrics"
              ]
            },
            "description": "Lista todas as m√©tricas dispon√≠veis.\n\nPara ver detalhes de uma m√©trica espec√≠fica:\n`GET /actuator/metrics/{metric.name}`\n\nExemplos:\n- `/actuator/metrics/jvm.memory.used`\n- `/actuator/metrics/http.server.requests`"
          },
          "response": []
        },
        {
          "name": "Prometheus Metrics",
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/actuator/prometheus",
              "host": [
                "{{api_url}}"
              ],
              "path": [
                "actuator",
                "prometheus"
              ]
            },
            "description": "Endpoint de m√©tricas no formato Prometheus.\n\nUse para integra√ß√£o com Prometheus/Grafana."
          },
          "response": []
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Script global executado antes de cada request",
          "// Valida se as vari√°veis essenciais est√£o configuradas",
          "",
          "const currentRequest = pm.request;",
          "const authType = currentRequest.auth ? currentRequest.auth.type : 'noauth';",
          "",
          "// Se o request requer autentica√ß√£o, valida token",
          "if (authType === 'bearer') {",
          "    const token = pm.environment.get('access_token');",
          "    if (!token) {",
          "        console.warn('‚ö†Ô∏è  Token n√£o encontrado. Execute \"Get Access Token\" primeiro.');",
          "    }",
          "}",
          "",
          "// Log do request sendo executado",
          "console.log('üöÄ Executando:', pm.request.name);"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Script global executado ap√≥s cada response",
          "",
          "// Log do resultado",
          "const statusCode = pm.response.code;",
          "const responseTime = pm.response.responseTime;",
          "",
          "if (statusCode >= 200 && statusCode < 300) {",
          "    console.log('‚úÖ Success:', statusCode, '| Response time:', responseTime + 'ms');",
          "} else if (statusCode >= 400 && statusCode < 500) {",
          "    console.warn('‚ö†Ô∏è  Client error:', statusCode, '| Response time:', responseTime + 'ms');",
          "} else if (statusCode >= 500) {",
          "    console.error('‚ùå Server error:', statusCode, '| Response time:', responseTime + 'ms');",
          "}",
          "",
          "// Valida tempo de resposta",
          "pm.test('Response time is acceptable (< 5000ms)', function () {",
          "    pm.expect(responseTime).to.be.below(5000);",
          "});"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "collection_version",
      "value": "1.2.1",
      "type": "string",
      "description": "Infrastructure update: OPA v1.9.0 with Rego v1 policies (2025-10-20)"
    }
  ]
}
