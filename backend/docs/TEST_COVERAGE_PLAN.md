# üéØ Plano de Melhoria de Cobertura de Testes

**Data:** 2025-10-18
**Cobertura Atual:** 66% instru√ß√µes, 50% branches
**Meta:** 80% instru√ß√µes, 70% branches

---

## üìä An√°lise da Cobertura Atual

### Por Pacote

| Pacote | Cobertura | Status | Prioridade |
|--------|-----------|--------|------------|
| **usuarios.domain** | 13% | ‚ùå CR√çTICO | üî¥ P0 |
| **usuarios.api** | 18% | ‚ùå CR√çTICO | üî¥ P0 |
| **shared.exception** | 61% | ‚ö†Ô∏è M√âDIO | üü° P1 |
| **usuarios.internal** | 58% | ‚ö†Ô∏è M√âDIO | üü° P1 |
| **shared.security** | 74% (25% branches) | ‚ö†Ô∏è M√âDIO | üü° P1 |
| **shared.internal** | 85% | ‚úÖ BOM | üü¢ P2 |
| **shared.authorization** | 81% | ‚úÖ BOM | üü¢ P2 |

---

## üéØ Gaps Cr√≠ticos Identificados

### üî¥ P0 - Cr√≠tico (Adicionar AGORA)

#### 1. **UserTenantsController** - 18% ‚ùå
**Problema:** Controller principal sem testes integrados

**Testes Necess√°rios:**
```java
// src/test/java/com/jetski/usuarios/api/UserTenantsControllerTest.java

@WebMvcTest(UserTenantsController.class)
class UserTenantsControllerTest {

    @Test
    void shouldListUserTenants_Success() {
        // GET /v1/user/tenants
        // Verificar lista de tenants do usu√°rio
    }

    @Test
    void shouldListUserTenants_Unauthorized() {
        // Sem JWT
        // Espera 401
    }

    @Test
    void shouldListUserTenants_EmptyList() {
        // Usu√°rio sem tenants
        // Espera lista vazia
    }

    @Test
    void shouldCountUserTenants_Success() {
        // GET /v1/user/tenants/count
        // Verificar contagem
    }

    @Test
    void shouldCountUserTenants_UnrestrictedAdmin() {
        // Platform admin
        // Espera -1 (unlimited)
    }
}
```

**Impacto Estimado:** +15% cobertura total

---

#### 2. **Entidades de Dom√≠nio** - 13% ‚ùå
**Problema:** Getters, setters e builders Lombok n√£o testados

**Abordagem:** Usar ArchUnit ou testes de contrato

```java
// src/test/java/com/jetski/usuarios/domain/DomainEntityTest.java

@ExtendWith(MockitoExtension.class)
class DomainEntityTest {

    @Test
    void usuarioBuilder_ShouldCreateValidEntity() {
        Usuario usuario = Usuario.builder()
            .id(UUID.randomUUID())
            .email("test@example.com")
            .nome("Test User")
            .ativo(true)
            .createdAt(Instant.now())
            .updatedAt(Instant.now())
            .build();

        assertThat(usuario.getEmail()).isEqualTo("test@example.com");
        assertThat(usuario.isAtivo()).isTrue();
    }

    @Test
    void membroBuilder_ShouldCreateValidEntity() {
        Membro membro = Membro.builder()
            .id(1)
            .tenantId(UUID.randomUUID())
            .usuarioId(UUID.randomUUID())
            .papeis(new String[]{"GERENTE", "OPERADOR"})
            .ativo(true)
            .build();

        assertThat(membro.getPapeis()).contains("GERENTE", "OPERADOR");
        assertThat(membro.isAtivo()).isTrue();
    }

    @Test
    void usuarioGlobalRoles_ShouldCreateValidEntity() {
        UsuarioGlobalRoles globalRoles = UsuarioGlobalRoles.builder()
            .usuarioId(UUID.randomUUID())
            .roles(new String[]{"PLATFORM_ADMIN"})
            .unrestrictedAccess(true)
            .build();

        assertThat(globalRoles.getUnrestrictedAccess()).isTrue();
        assertThat(globalRoles.getRoles()).contains("PLATFORM_ADMIN");
    }

    @Test
    void entities_ShouldSupportEqualsAndHashCode() {
        UUID id = UUID.randomUUID();

        Usuario u1 = Usuario.builder().id(id).email("test@example.com").build();
        Usuario u2 = Usuario.builder().id(id).email("test@example.com").build();

        // Lombok gera equals/hashCode baseado em todos os campos
        // Teste b√°sico de consist√™ncia
        assertThat(u1.getId()).isEqualTo(u2.getId());
    }
}
```

**Impacto Estimado:** +8% cobertura total

---

### üü° P1 - Importante (Adicionar em Seguida)

#### 3. **GlobalExceptionHandler** - 61% ‚ö†Ô∏è
**Problema:** Alguns exception handlers n√£o testados

```java
// src/test/java/com/jetski/shared/exception/GlobalExceptionHandlerTest.java

@WebMvcTest
@Import(GlobalExceptionHandler.class)
class GlobalExceptionHandlerTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    void shouldHandleMethodArgumentNotValid() throws Exception {
        // POST com JSON inv√°lido
        // Espera 400 com detalhes de valida√ß√£o
    }

    @Test
    void shouldHandleHttpMessageNotReadable() throws Exception {
        // POST com JSON malformado
        // Espera 400
    }

    @Test
    void shouldHandleHttpRequestMethodNotSupported() throws Exception {
        // POST em endpoint GET
        // Espera 405
    }

    @Test
    void shouldHandleHttpMediaTypeNotSupported() throws Exception {
        // Content-Type inv√°lido
        // Espera 415
    }

    @Test
    void shouldHandleMissingServletRequestParameter() throws Exception {
        // Query param obrigat√≥rio faltando
        // Espera 400
    }

    @Test
    void shouldHandleConstraintViolation() throws Exception {
        // Viola√ß√£o de @Valid
        // Espera 400 com detalhes
    }
}
```

**Impacto Estimado:** +5% cobertura total

---

#### 4. **TenantAccessService** - Branches n√£o testadas
**Problema:** Faltam cen√°rios edge case

```java
// Adicionar em TenantAccessServiceTest.java

@Test
@DisplayName("Should handle concurrent access validation")
void testConcurrentAccess() throws InterruptedException {
    // Simular m√∫ltiplas threads validando acesso
    // Verificar thread-safety do cache
}

@Test
@DisplayName("Should return correct count for user with multiple tenants")
void testCountWithLargeTenantList() {
    when(globalRolesRepository.findById(usuarioId))
        .thenReturn(Optional.empty());
    when(membroRepository.countActiveByUsuario(usuarioId))
        .thenReturn(100L);

    long count = tenantAccessService.countUserTenants(usuarioId);

    assertThat(count).isEqualTo(100L);
}

@Test
@DisplayName("Should validate access with expired membership")
void testExpiredMembership() {
    // Membro inativo
    Membro membro = createMembro(tenantId, usuarioId, "GERENTE");
    membro.setAtivo(false);

    when(membroRepository.findActiveByUsuarioAndTenant(usuarioId, tenantId))
        .thenReturn(Optional.empty()); // N√£o retorna inativos

    TenantAccessInfo result = tenantAccessService.validateAccess(usuarioId, tenantId);

    assertThat(result.isHasAccess()).isFalse();
}
```

**Impacto Estimado:** +3% cobertura total

---

#### 5. **SecurityConfig** - Testes de configura√ß√£o
**Problema:** Beans e configura√ß√µes n√£o testados

```java
// src/test/java/com/jetski/shared/security/SecurityConfigTest.java

@SpringBootTest
@AutoConfigureMockMvc
class SecurityConfigTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    void publicEndpoints_ShouldBeAccessibleWithoutAuth() throws Exception {
        mockMvc.perform(get("/actuator/health"))
            .andExpect(status().isOk());

        mockMvc.perform(get("/swagger-ui.html"))
            .andExpect(status().isOk());
    }

    @Test
    void protectedEndpoints_ShouldRequireAuth() throws Exception {
        mockMvc.perform(get("/v1/user/tenants"))
            .andExpect(status().isUnauthorized());
    }

    @Test
    void corsConfiguration_ShouldAllowConfiguredOrigins() throws Exception {
        mockMvc.perform(options("/v1/user/tenants")
                .header("Origin", "http://localhost:3000")
                .header("Access-Control-Request-Method", "GET"))
            .andExpect(status().isOk())
            .andExpect(header().exists("Access-Control-Allow-Origin"));
    }

    @Test
    void jwtConverter_ShouldExtractRolesFromToken() {
        // Verificar que JwtAuthenticationConverter √© configurado
        // e extrai roles corretamente
    }
}
```

**Impacto Estimado:** +4% cobertura total

---

#### 6. **AuthTestController** - Mais cen√°rios
**Problema:** Faltam edge cases

```java
// Adicionar em AuthTestControllerIntegrationTest.java

@Test
void shouldRejectExpiredToken() throws Exception {
    // JWT expirado
    // Espera 401
}

@Test
void shouldRejectInvalidIssuer() throws Exception {
    // JWT de issuer n√£o confi√°vel
    // Espera 401
}

@Test
void shouldRejectMalformedToken() throws Exception {
    // JWT malformado
    // Espera 401
}

@Test
void shouldHandleMissingRoleClaim() throws Exception {
    // JWT sem claim de roles
    // Deve funcionar (roles vazias)
}

@Test
void shouldValidateTenantIdFormat() throws Exception {
    // X-Tenant-Id com formato inv√°lido
    // Espera 400
}
```

**Impacto Estimado:** +3% cobertura total

---

### üü¢ P2 - Opcional (Melhorias)

#### 7. **Testes de Integra√ß√£o Adicionais**

```java
// src/test/java/com/jetski/integration/CacheIntegrationTest.java

@SpringBootTest
@Testcontainers
class CacheIntegrationTest extends AbstractIntegrationTest {

    @Test
    void tenantAccessCache_ShouldCacheResults() {
        // Verificar que validateAccess usa cache Redis
        // 1¬™ chamada: hit no DB
        // 2¬™ chamada: hit no cache
    }

    @Test
    void cacheEviction_ShouldClearOnUpdate() {
        // Atualizar membro
        // Verificar que cache foi invalidado
    }
}
```

**Impacto Estimado:** +2% cobertura total

---

## üìà Proje√ß√£o de Melhoria

### Execu√ß√£o do Plano

| Fase | Testes | Impacto | Cobertura Projetada |
|------|--------|---------|---------------------|
| **Atual** | 89 | - | 66% / 50% |
| **+ P0** | +15 | +23% | 82% / 60% |
| **+ P1** | +20 | +15% | 85% / 70% |
| **+ P2** | +5 | +3% | 87% / 72% |
| **TOTAL** | **129** | **+41%** | **87% / 72%** ‚úÖ |

---

## üöÄ Ordem de Execu√ß√£o Recomendada

### Sprint 1 (P0 - Cr√≠tico)

1. ‚úÖ Criar `UserTenantsControllerTest.java` (5 testes)
2. ‚úÖ Criar `DomainEntityTest.java` (10 testes)
3. ‚úÖ Rodar cobertura e verificar aumento

**Tempo estimado:** 2-3 horas
**Impacto:** +23% cobertura

### Sprint 2 (P1 - Importante)

1. ‚úÖ Expandir `GlobalExceptionHandlerTest.java` (+6 testes)
2. ‚úÖ Adicionar edge cases em `TenantAccessServiceTest.java` (+3 testes)
3. ‚úÖ Criar `SecurityConfigTest.java` (+4 testes)
4. ‚úÖ Expandir `AuthTestControllerIntegrationTest.java` (+5 testes)
5. ‚úÖ Rodar cobertura e verificar progresso

**Tempo estimado:** 3-4 horas
**Impacto:** +15% cobertura

### Sprint 3 (P2 - Opcional)

1. ‚úÖ Criar `CacheIntegrationTest.java` (+5 testes)
2. ‚úÖ Meta alcan√ßada: 85%+

**Tempo estimado:** 1-2 horas
**Impacto:** +3% cobertura

---

## üéØ Checklist de Valida√ß√£o

Ap√≥s cada sprint, verificar:

```bash
# Rodar testes
mvn clean test

# Gerar relat√≥rio
mvn jacoco:report

# Ver relat√≥rio
open target/site/jacoco/index.html

# Verificar m√©tricas
cat target/site/jacoco/index.html | grep "Total"
```

**Crit√©rios de Sucesso:**
- ‚úÖ Cobertura de instru√ß√µes > 80%
- ‚úÖ Cobertura de branches > 70%
- ‚úÖ Todos os controllers testados
- ‚úÖ Entidades de dom√≠nio cobertas
- ‚úÖ Exception handlers testados

---

## üìä Comandos √öteis

```bash
# Apenas cobertura (sem rodar aplica√ß√£o)
mvn clean test jacoco:report

# Ver coverage por classe
ls -lh target/site/jacoco/com.jetski.*/*.html

# Coverage de um pacote espec√≠fico
open target/site/jacoco/com.jetski.usuarios.api/index.html

# Verificar se algum teste est√° falhando
mvn test 2>&1 | grep -E "Tests run|FAILURE|ERROR"
```

---

## üéì Boas Pr√°ticas Aplicadas

### 1. Testes de Valor vs Coverage Artificial
- ‚ùå N√ÉO criar testes s√≥ para aumentar coverage
- ‚úÖ Focar em cen√°rios reais e edge cases
- ‚úÖ Testar comportamento, n√£o implementa√ß√£o

### 2. Pir√¢mide de Testes
```
         /\
        /  \  E2E (poucos)
       /‚îÄ‚îÄ‚îÄ‚îÄ\
      /      \  Integration (m√©dio)
     /‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\
    /          \  Unit (muitos)
   /‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\
```

### 3. Princ√≠pios FIRST
- **Fast** - Testes r√°pidos (<1s cada)
- **Independent** - Sem depend√™ncias entre testes
- **Repeatable** - Mesmo resultado sempre
- **Self-validating** - Passa ou falha claramente
- **Timely** - Escrito junto com o c√≥digo

### 4. AAA Pattern
```java
@Test
void testName() {
    // Arrange - Setup

    // Act - Executar a√ß√£o

    // Assert - Verificar resultado
}
```

---

## üìù Notas

### Classes Exclu√≠das do Coverage (Configura√ß√£o Maven)
```xml
<excludes>
    **/dto/**
    **/config/**
    **/*Application.*
    **/exception/ErrorResponse.*
    **/exception/GlobalExceptionHandler.*
    **/exception/InvalidTenantException.*
    **/security/FilterChainExceptionFilter.*
</excludes>
```

**Aten√ß√£o:** Remover `GlobalExceptionHandler` da exclus√£o ap√≥s criar testes!

---

**Vers√£o:** 1.0
**√öltima atualiza√ß√£o:** 2025-10-18
**Pr√≥xima revis√£o:** Ap√≥s implementar P0
